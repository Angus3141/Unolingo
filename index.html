<script>
  const voiceButtonsContainer = document.getElementById("voice-buttons");

  function speakWithVoice(voice) {
    const phrase = document.getElementById("phrase").value;
    const utterance = new SpeechSynthesisUtterance(phrase);
    utterance.voice = voice;
    speechSynthesis.cancel();
    speechSynthesis.speak(utterance);
  }

  function displayVoices() {
    const voices = speechSynthesis.getVoices();
    const italianVoices = voices.filter(v => v.lang.startsWith("it"));
    voiceButtonsContainer.innerHTML = "";

    if (italianVoices.length === 0) {
      voiceButtonsContainer.innerHTML = `
        <p>No Italian voices detected.<br>
        Go to <strong>Settings â†’ Accessibility â†’ Spoken Content â†’ Voices â†’ Italian</strong><br>
        and download Luca (Enhanced).</p>`;
      return;
    }

    // Try to auto-select Luca (Enhanced) if present
    const lucaVoice = italianVoices.find(v => v.name.toLowerCase().includes("luca"));

    if (lucaVoice) {
      const autoBtn = document.createElement("button");
      autoBtn.textContent = `ðŸ”Š Speak with preferred: ${lucaVoice.name}`;
      autoBtn.onclick = () => speakWithVoice(lucaVoice);
      voiceButtonsContainer.appendChild(autoBtn);
    }

    italianVoices.forEach(voice => {
      const btn = document.createElement("button");
      btn.textContent = `${voice.name} (${voice.lang})`;
      btn.onclick = () => speakWithVoice(voice);
      voiceButtonsContainer.appendChild(btn);
    });
  }

  function waitForVoices(maxTries = 10) {
    let tries = 0;

    const interval = setInterval(() => {
      const voices = speechSynthesis.getVoices();
      if (voices.length > 1 || tries >= maxTries) {
        clearInterval(interval);
        displayVoices();
      }
      tries++;
    }, 250);
  }

  document.addEventListener("DOMContentLoaded", () => {
    if (typeof speechSynthesis === "undefined") {
      voiceButtonsContainer.innerHTML = "<p>Speech synthesis not supported in this browser.</p>";
      return;
    }

    speechSynthesis.getVoices(); // Trigger voice population
    waitForVoices();
  });
</script>
